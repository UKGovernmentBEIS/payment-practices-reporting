@(htmlTitle: String, surveyMonkeyConfig: config.SurveyMonkeyConfig)(content: Html)(implicit pageContext: PageContext)

@head = {
}

@govukTemplate(
    Some(htmlTitle),
    bodyClasses = None,
    htmlLang = None
)(
    head = head,
    bodyStart = HtmlFormat.empty,
    bodyEnd = HtmlFormat.empty,
    insideHeader = HtmlFormat.empty,
    afterHeader = HtmlFormat.empty,
    footerTop = shared._footer(pageContext.externalRouter),
    footerLinks = HtmlFormat.empty,
    headerClass = Html("with-proposition"),
    propositionHeader = Html("<div class=\"header-proposition\"><div class=\"content\"><nav id=\"proposition-menu\"><a id=\"proposition-name\" href=\"/\">"
            + shared._name() + "</a></nav></div></div>"),
    homepageUrl = None,
    globalHeaderText = None,
    cookieMessage = None,
    skipLinkMessage = None,
    skipLinkTarget = "contentStart",
    logoLinkTitle = None,
    licenceMessage = Html("<p>All content is available under the " +
            "<a rel=\"license\" href=\"https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/\">Open Government Licence v3.0</a>," +
            " except where otherwise stated</p>"),
    crownCopyrightMessage = None
) {

    <main id="content" role="main">
        <div class="phase-banner-beta">
            <p>
                <strong class="phase-tag">BETA</strong>
                @surveyMonkeyConfig.feedbackFormCode.map { code =>
                    <span>
                        This is a new service â€“ your
                        <a rel="external" href="https://www.surveymonkey.co.uk/r/@code">feedback</a>
                        will help us to improve it.
                    </span>
                }
            </p>
        </div>
        @content
    </main>
    @pageContext.googleAnalyticsConfig.code.map { code =>
        <script>
          function extractParams() {
            var urlParams = {},
              match,
              search = /([^&=]+)=?([^&]*)/g,
              query = window.location.search.substring(1);

            while (match = search.exec(query)) {
              urlParams[match[1]] = match[2];
            }
            return urlParams;
          }

          //Rewrite URL
          function rewriteURL() {
            var urlParams = extractParams();

            var keys = Object.keys(urlParams).sort();

            if (keys.length == 0) {
              return window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.hash
            }
            var params = "?";

            for (var i = 0; i < keys.length; i++) {
              var key = keys[i];
              var urlParam = urlParams[key];

              key = replaceRegex(key);
              urlParam = replaceRegex(urlParam);

              if (i > 0) {
                params = params.concat("&")
              }
              if (urlParam !== '') {
                params = params.concat(key + "=" + urlParam)
              }
              else {
                params += key;
              }
            }
            return window.location.protocol + "//" + window.location.host + window.location.pathname + params + window.location.hash
          }

          function replaceRegex(string) {
            var emailRegex = /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/
            var telRegex = /^(\+44\s?7\d{3}|\(?07\d{3}\)?)\s?\d{3}\s?\d{3}$/
            var postcodeRegex = /^(([gG][iI][rR] {0,}0[aA]{2})|((([a-pr-uwyzA-PR-UWYZ][a-hk-yA-HK-Y]?[0-9][0-9]?)|(([a-pr-uwyzA-PR-UWYZ][0-9][a-hjkstuwA-HJKSTUW])|([a-pr-uwyzA-PR-UWYZ][a-hk-yA-HK-Y][0-9][abehmnprv-yABEHMNPRV-Y]))) {0,}[0-9][abd-hjlnp-uw-zABD-HJLNP-UW-Z]{2}))$/

            string = decodeURIComponent(string).replace('+', ' ');

            string = string.replace(emailRegex, "[email]");
            string = string.replace(telRegex, "[tel]");
            string = string.replace(postcodeRegex, "[postcode]");

            return string;
          }
          
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', '@code', 'auto', 'govuk_shared', { 'allowLinker': true });
          ga('govuk_shared.require', 'linker');
          ga('govuk_shared.linker.set', 'anonymizeIp', true);
          ga('govuk_shared.linker:autoLink', ['www.gov.uk', 'check-payment-practices.service.gov.uk']);

          ga('govuk_shared.set', 'location', rewriteURL(window.location.href));
          ga('govuk_shared.send', 'pageview');
        </script>
    }

}
